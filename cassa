#!/bin/bash
exec > /var/log/cassandra-setup.log 2>&1
set -x

# Variables
NODE_NUMBER="${node_number}"
IS_SEED="${is_seed}"
CLUSTER_NAME="${cluster_name}"
SEED_IP="${seed_ip}"
NATIVE_PORT="${native_port}"
SSL_PORT="${ssl_port}"
STORAGE_PORT="${storage_port}"
SSL_STORAGE_PORT="${ssl_storage_port}"
CASSANDRA_USERNAME="${cassandra_username}"
CASSANDRA_PASSWORD="${cassandra_password}"
KEYSTORE_PASSWORD="${ssl_keystore_password}"
TRUSTSTORE_PASSWORD="${ssl_truststore_password}"

# Get metadata
TOKEN=`curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
PRIVATE_IP=`curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-ipv4`

# Update and install Java
dnf update -y
dnf install -y java-11-amazon-corretto wget tar

# Create user
groupadd -r cassandra || true
useradd -r -g cassandra -d /var/lib/cassandra -s /sbin/nologin cassandra || true

# Download Cassandra
cd /tmp
wget -q https://archive.apache.org/dist/cassandra/4.1.7/apache-cassandra-4.1.7-bin.tar.gz
tar -xzf apache-cassandra-4.1.7-bin.tar.gz
mv apache-cassandra-4.1.7 /opt/cassandra

# Create directories
mkdir -p /var/lib/cassandra/{data,commitlog,saved_caches,hints}
mkdir -p /var/log/cassandra /opt/cassandra/conf/ssl
chown -R cassandra:cassandra /var/lib/cassandra /var/log/cassandra /opt/cassandra

# SSL certs - use /opt/cassandra/conf/ssl since Cassandra reads from there
SSL_DIR=/opt/cassandra/conf/ssl
keytool -genkeypair -alias node-$NODE_NUMBER -keyalg RSA -keysize 2048 -validity 365 \
    -keystore $SSL_DIR/cassandra.keystore -storepass "$KEYSTORE_PASSWORD" -keypass "$KEYSTORE_PASSWORD" \
    -dname "CN=$PRIVATE_IP, OU=IT, O=Org, L=City, ST=State, C=US" -ext "san=ip:$PRIVATE_IP"
keytool -exportcert -alias node-$NODE_NUMBER -keystore $SSL_DIR/cassandra.keystore \
    -storepass "$KEYSTORE_PASSWORD" -file $SSL_DIR/node-$NODE_NUMBER.crt -rfc
keytool -importcert -alias node-$NODE_NUMBER -keystore $SSL_DIR/cassandra.truststore \
    -storepass "$TRUSTSTORE_PASSWORD" -file $SSL_DIR/node-$NODE_NUMBER.crt -noprompt
chown -R cassandra:cassandra $SSL_DIR && chmod 600 $SSL_DIR/*

# Determine seeds
[ "$IS_SEED" = "true" ] && SEEDS="$PRIVATE_IP" || SEEDS="$SEED_IP"

# Configure cassandra.yaml - write to /opt/cassandra/conf/ where Cassandra actually reads from
cat > /opt/cassandra/conf/cassandra.yaml << EOF
cluster_name: '$CLUSTER_NAME'
num_tokens: 256
authenticator: PasswordAuthenticator
authorizer: CassandraAuthorizer
role_manager: CassandraRoleManager
partitioner: org.apache.cassandra.dht.Murmur3Partitioner
data_file_directories: [/var/lib/cassandra/data]
commitlog_directory: /var/lib/cassandra/commitlog
commitlog_sync: periodic
commitlog_sync_period: 10000ms
saved_caches_directory: /var/lib/cassandra/saved_caches
hints_directory: /var/lib/cassandra/hints
seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds: "$SEEDS"
listen_address: $PRIVATE_IP
broadcast_address: $PRIVATE_IP
rpc_address: 0.0.0.0
broadcast_rpc_address: $PRIVATE_IP
native_transport_port: $NATIVE_PORT
native_transport_port_ssl: $SSL_PORT
storage_port: $STORAGE_PORT
ssl_storage_port: $SSL_STORAGE_PORT
endpoint_snitch: SimpleSnitch
client_encryption_options:
  enabled: true
  optional: true
  keystore: $SSL_DIR/cassandra.keystore
  keystore_password: $KEYSTORE_PASSWORD
  truststore: $SSL_DIR/cassandra.truststore
  truststore_password: $TRUSTSTORE_PASSWORD
server_encryption_options:
  internode_encryption: all
  keystore: $SSL_DIR/cassandra.keystore
  keystore_password: $KEYSTORE_PASSWORD
  truststore: $SSL_DIR/cassandra.truststore
  truststore_password: $TRUSTSTORE_PASSWORD
EOF

# JVM options - overwrite the default files with minimal memory settings for t3.micro
# Remove all existing jvm options files and create minimal ones
rm -f /opt/cassandra/conf/jvm*.options

cat > /opt/cassandra/conf/jvm-server.options << 'EOF'
-Xms256M
-Xmx256M
-XX:+UseG1GC
-XX:+ParallelRefProcEnabled
-XX:MaxGCPauseMillis=500
-XX:+AlwaysPreTouch
-Djava.net.preferIPv4Stack=true
-XX:+ExitOnOutOfMemoryError
-XX:+HeapDumpOnOutOfMemoryError
-Xss256k
EOF

cat > /opt/cassandra/conf/jvm11-server.options << 'EOF'
-Djdk.attach.allowAttachSelf=true
--add-exports java.base/jdk.internal.misc=ALL-UNNAMED
--add-exports java.base/jdk.internal.ref=ALL-UNNAMED
--add-exports java.base/sun.nio.ch=ALL-UNNAMED
--add-exports java.management.rmi/com.sun.jmx.remote.internal.rmi=ALL-UNNAMED
--add-exports java.rmi/sun.rmi.registry=ALL-UNNAMED
--add-exports java.rmi/sun.rmi.server=ALL-UNNAMED
--add-exports java.sql/java.sql=ALL-UNNAMED
--add-opens java.base/java.lang.module=ALL-UNNAMED
--add-opens java.base/jdk.internal.loader=ALL-UNNAMED
--add-opens java.base/jdk.internal.ref=ALL-UNNAMED
--add-opens java.base/jdk.internal.reflect=ALL-UNNAMED
--add-opens java.base/jdk.internal.math=ALL-UNNAMED
--add-opens java.base/jdk.internal.module=ALL-UNNAMED
--add-opens java.base/jdk.internal.util.jar=ALL-UNNAMED
--add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED
-Dio.netty.tryReflectionSetAccessible=true
EOF

chown -R cassandra:cassandra /opt/cassandra

# Systemd service
cat > /etc/systemd/system/cassandra.service << 'EOF'
[Unit]
Description=Apache Cassandra
After=network.target
[Service]
Type=forking
User=cassandra
Group=cassandra
Environment="CASSANDRA_HOME=/opt/cassandra"
Environment="JAVA_HOME=/usr/lib/jvm/java-11-amazon-corretto"
ExecStart=/opt/cassandra/bin/cassandra -p /var/run/cassandra/cassandra.pid
PIDFile=/var/run/cassandra/cassandra.pid
LimitNOFILE=100000
LimitMEMLOCK=infinity
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF

mkdir -p /var/run/cassandra && chown cassandra:cassandra /var/run/cassandra
systemctl daemon-reload && systemctl enable cassandra && systemctl start cassandra

# Wait and create user
sleep 120
if [ "$IS_SEED" = "true" ]; then
    for i in 1 2 3 4 5 6 7 8 9 10; do
        /opt/cassandra/bin/cqlsh -u cassandra -p cassandra $PRIVATE_IP -e \
            "CREATE ROLE IF NOT EXISTS '$CASSANDRA_USERNAME' WITH PASSWORD = '$CASSANDRA_PASSWORD' AND SUPERUSER = true AND LOGIN = true;" 2>/dev/null && break
        sleep 15
    done
fi
echo "Setup complete for node $NODE_NUMBER"
  
